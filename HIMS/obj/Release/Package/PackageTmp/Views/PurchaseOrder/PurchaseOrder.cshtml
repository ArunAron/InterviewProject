@model DataCore.Models.Stock

@{
    ViewBag.Title = "Opening Stock";
}

<style>
</style>
<div class="card card-body  col-lg-12" style="border-radius:10px">
    <div class="row">

        <div class=" col-lg-6 mt-10"><h4 class="panel-title font-weight-bold mt-20">Purchase Order Form</h4></div>
        <div class=" col-lg-3"></div>
        <div class=" col-lg-3 ">
            <label class="font-weight-bold">Warehouse</label>
            <input type="text" id="Warehouse" class=" form-control font-weight-bold" style="background-color:gainsboro" readonly name="Warehouse" value="@ViewBag.WarehouseName" />
        </div>

    </div>
    <hr class="bg-brown-800" />
    <div class="">
        <!-- Search Fliters -->
        <div class=" mt-2  row">
            @*<div class="form-group col-lg-3 mt-1">
                    <label class="font-weight-bold">Purchase Order No</label>
                    <input onfocus="onFocus('PurchaseOrderNo')" type="text" id="PurchaseOrderNo" class=" form-control" name="PurchaseOrderNo" />
                </div>*@
            <div class="form-group col-lg-3 mt-1">
                <label class="font-weight-bold">Purchase Order Date</label>
                <input onfocus="onFocus('PurchaseOrderDate')" type="date" id="PurchaseOrderDate" class=" form-control " name="PurchaseOrderDate" />
            </div>
            <div class="form-group col-lg-3 mt-1">
                <label class="font-weight-bold">Supplier</label>
                <input onfocus="onFocus('Supplier')" type="text" id="Supplier" class=" form-control " name="Supplier" />
                <input type="hidden" class="form-control" id="SupplierGUID" name="SupplierGUID" autocomplete="off" />
            </div>
            <div class="form-group col-lg-3 mt-1">
                <label class="font-weight-bold">Company Location</label>
                <input onfocus="onFocus('CompanyLocation')" type="text" id="CompanyLocation" class=" form-control " name="CompanyLocation" />
            </div>
            <div class="form-group col-lg-3 mt-1">
                <label class="font-weight-bold">FarmerCode</label>
                <input onfocus="onFocus('FarmerCode')" type="text" id="FarmerCode" class=" form-control " name="FarmerCode" />
            </div>
            <div class="form-group col-lg-3 mt-1">
                <label class="font-weight-bold">Vehicle Detail</label>
                <input onfocus="onFocus('VehicleDetail')" type="text" id="VehicleDetail" class=" form-control " name="VehicleDetail" />
            </div>
        </div>

        <div class="panel panel-flat mt-4 " style="border-radius:10px">
            <div class="table-responsive" style="border-radius:10px">
                <table id="tblOne" class="table table-sm">
                    <thead class="">
                        <tr>
                            <th>#</th>
                            <th class="pl-1 pr-1 text-center">Material Name   </th>
                            <th class="pl-1 pr-1 text-center" colspan="2">Quantity</th>
                            <th class="pl-1 pr-1 text-center" colspan="2">Weight Per Qty</th>
                            <th class="pl-1 pr-1 text-center" colspan="2">Total Weight</th>
                            <th class="pl-1 pr-1 text-center">Rate</th>
                            <th class="pl-1 pr-1 text-center">Amount</th>
                            <th class="pl-1 pr-1 text-center">Packing Detail</th>
                            <th class="pl-1 pr-1 text-center">Remark</th>
                            <th class="pl-1 pr-1 text-center"></th>
                        </tr>
                    </thead>
                    <!-- Table Body -->

                    <tbody>
                        <tr id="tr1">
                            <td>
                                <span>1</span>
                            </td>
                            <td class="pl-1 pr-1">
                                <input style="min-width:150px" type="text" class="form-control" id="MaterialName1" name="MaterialName1" autocomplete="off" onkeydown="SetAutoComplete('MaterialName1', '1')" ondblclick="doubleClick('MaterialName1', '1')" onfocus="onFocus('MaterialName1')" />
                                <input type="hidden" class="form-control" id="MaterialGUID1" name="MaterialGUID1" autocomplete="off" />
                            </td>
                            <td class="pl-1 pr-0">
                                <input style="min-width:80px" type="number" class="form-control" id="Quantity1" name="Quantity1" autocomplete="off" onfocus="onFocus('Quantity1')" min="1" oninput="validity.valid||(value='');" onkeyup="CalculateAmount('1')" />
                            </td>
                            <td class="pl-0 pr-1">
                                <select style="min-width:105px" id="QuantityUOMType1" name="QuantityUOMType1" class="form-control bg-light">
                                </select>
                            </td>
                            <td class="pl-1 pr-0">
                                <input style="min-width:80px" type="number" class="form-control" id="WeightPerQuantity1" name="WeightPerQuantity1" autocomplete="off" onfocus="onFocus('Quantity1')" min="1" oninput="validity.valid||(value='');" />
                            </td>
                            <td class="pl-0 pr-1">
                                <select style="min-width:105px" id="WeightPerQuantityUOMType1" name="WeightPerQuantityUOMType1" class="form-control bg-light">
                                </select>
                            </td>
                            <td class="pl-1 pr-0">
                                <input style="min-width:80px" type="number" class="form-control" id="TotalWeight1" name="TotalWeight1" autocomplete="off" min="1" oninput="validity.valid||(value='');" />
                            </td>
                            <td class="pl-0 pr-1">
                                <select style="min-width:105px" id="TotalWeightUOMType1" name="TotalWeightUOMType1" class="form-control bg-light"></select>
                            </td>
                            <td class="pl-1 pr-1">
                                <input onfocus="onFocus('Rate1')" style="min-width:100px" type="number" class="form-control" id="Rate1" name="Rate1" autocomplete="off" min="1" oninput="validity.valid||(value='');" onkeyup="CalculateAmount('1')" />
                            </td>
                            <td class="pl-1 pr-1">
                                <input onfocus="onFocus('Amount1')" style="min-width:100px" type="number" class="form-control" id="Amount1" name="Amount1" autocomplete="off" min="1" oninput="validity.valid||(value='');" />
                            </td>
                            <td class="pl-1 pr-1">
                                <input onfocus="onFocus('PackingDetail1')" style="min-width:150px" type="text" class="form-control" id="PackingDetail1" name="PackingDetail1" autocomplete="off" />
                            </td>
                            <td class="pl-1 pr-1">
                                <input onfocus="onFocus('ExpiryDate1')" style="min-width:150px" type="text" class="form-control" id="Remark1" name="Remark1" autocomplete="off" />
                            </td>
                            <td class="pl-1 pr-1">
                                <button class="btn btn-sm btn-icon rounded-round  btn-success" id="Add1" onclick="AddNewRow(1)">
                                    <b><i class="icon-plus22"></i></b>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>

            </div>

        </div>

    </div>


</div>
<div class="text-right">
    <button id="savebutton" class="btn btn-labeled btn-labeled-right rounded-round btn-lg bg-teal-800 btn-labeled"><b><i class="icon-floppy-disk"></i></b> Save</button>
</div>
<input type="hidden" id="totalCount" name="totalCount" value="1" />

<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm  modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-slate-800" style="border-radius:0">
                <h5 class="modal-title" id="exampleModalLabel">Confirm Save</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to save !
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" id="btnSubmit" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>



<script>
    $(document).ready(function () {
        //$('#dtBasicExample').DataTable({
        //    searching: false,
        //});
        $('#fromdate').datepicker({
            format: 'dd-mm-yyyy',
        });

        $('#savebutton').click(function () {
            var warehouse = $('#Warehouse').val();
            var errorexit = 0;
            if (warehouse == "") {
                $('#Warehouse').removeClass("hidden");
                errorexit++;
            }
            errorexit += CheckValidationAllRow();

            if (errorexit == 0) {
                $('#Type').addClass("hidden");
                $('#confirmModal').modal('show');
            }
        });

        $("#Supplier").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: '@Url.Action("GetSupplierNameReturnGUID", "Common")',
                    type: "POST",
                    dataType: "json",
                    data: { Prefix: request.term },
                    success: function (data) {
                        response($.map(data, function (item) {
                            return {
                                label: item.SupplierName,
                                value: item.SupplierName,
                                id: item.GUID
                            };
                        }));
                    }

                })
            },
            select: function (event, ui) {
                $("#SupplierGUID").val(ui.item.id);
            },
            messages: {
                noResults: "",
                results: function (count) {
                    return count + (count > 1 ? ' results' : ' result ') + ' found';
                }
            }
        });


    });

    $('#Warehouse').focus(function () {
        $('#Warehouse').addClass("hidden");
    });

    function CalculateAmount(count) {
        var Quantity = $('#Quantity' + count).val();
        var Rate = $('#Rate' + count).val();
        if (Quantity == null) {
            Quantity = 0;
        }
        if (Rate == null) {
            Rate = 0;
        }
      var Amount = Rate * Quantity;
        $('#Amount' + count).val(Amount);
    }

    function SetAutoComplete(id, count) {


        //var MaterialGUID = document.getElementById(id).value;
        //var warehouseID = $('#Warehouse').val();
        //var MaterialGUID = $('#MaterialGUID' + count).val();

        $('#' + id).autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: '@Url.Action("GetMaterialNameReturnGUID", "Common")',
                    type: "POST",
                    dataType: "json",
                    data: { Prefix: request.term },
                    success: function (data) {
                        response($.map(data, function (item) {
                            return {
                                label: item.MaterialName,
                                value: item.MaterialName,
                                id: item.GUID
                            };
                        }));
                    }

                })
            },
            select: function (event, ui) {
                var mtID = "MaterialGUID" + count;
                var TotalWeightUOMTypeID = "TotalWeightUOMType" + count;
                var QuantityUOMTypeID = "QuantityUOMType" + count;
                var WeightPerQuantityUOMTypeID = "WeightPerQuantityUOMType" + count;

                $('#' + id).attr("readonly", true);
                $('#' + mtID).val(ui.item.id);

                $.ajax({
                    url:'@Url.Action("GetUOMByMaterialGUID", "Common")',
                    type: 'Post',
                    data: { Prefix: $('#' + mtID).val() },
                    success: function (data) {
                        var items = "";
                        $.each(data, function (i, val) {
                            items += "<option value='" + val.Type + "'>" + val.Type + "</option>";
                        });
                        $('#' + TotalWeightUOMTypeID).empty().html(items);
                        $('#' + QuantityUOMTypeID).empty().html(items);
                        $('#' + WeightPerQuantityUOMTypeID).empty().html(items);
                    }
                });
              },
            messages: {
                noResults: "",
                results: function (count) {
                    return count + (count > 1 ? ' results' : ' result ') + ' found';
                }
            }
        });
    }


    function doubleClick(id, count) {

        if ($("#" + id).attr("readonly")) {
            $("#" + id).attr("readonly", false);
        }
    }

    function onFocus(id) {
        $("#" + id).removeClass("border-danger");
    }

    function checkValidationCurrentRow(count) {

        var checkMaterialName = $('#MaterialName' + count).val();
        var checkMaterialGUID = $('#MaterialGUID' + count).val();
        var checkQuantity = $('#Quantity' + count).val();
        var checkPackingDetail = $('#PackingDetail' + count).val();
        var checkRate = $('#Rate' + count).val();
        var checkAmount = $('#Amount' + count).val();

        var errorexit = 0;

        if (checkMaterialName == "") {
            $('#MaterialName' + count).addClass("border-danger");
            errorexit++;
        }
        if (checkMaterialGUID == "") {
            $('#MaterialName' + count).addClass("border-danger");
            errorexit++;
        }
        if (checkQuantity == "") {
            $('#Quantity' + count).addClass("border-danger");
            errorexit++;
        }
        if (checkRate == "") {
            $('#Rate' + count).addClass("border-danger");
            errorexit++;
        }
        if (checkAmount == "") {
            $('#Amount' + count).addClass("border-danger");
            errorexit++;
        }
        if (checkPackingDetail == "") {
            $('#PackingDetail' + count).addClass("border-danger");
            errorexit++;
        }
        return errorexit;
    }

    function CheckValidationAllRow() {
        var errorexit = 0;
        var count = 1;

        //var PurchaseOrderNo = $('#PurchaseOrderNo').val();
        var SupplierGUID = $('#SupplierGUID').val();
        var CompanyLocation = $('#CompanyLocation').val();
        var PurchaseOrderDate = $('#PurchaseOrderDate').val();
        var VehicleDetail = $('#VehicleDetail').val();
        var CompanyLocation = $('#CompanyLocation').val();
        var FarmerCode = $('#FarmerCode').val();

        //if (PurchaseOrderNo == "") {
        //    $('#PurchaseOrderNo').addClass("border-danger");
        //    errorexit++;
        //}
        if (SupplierGUID == "") {
            $('#Supplier').addClass("border-danger");
            errorexit++;
        }
        if (PurchaseOrderDate == "") {
            $('#PurchaseOrderDate').addClass("border-danger");
            errorexit++;
        }
        if (FarmerCode == "") {
            $('#FarmerCode').addClass("border-danger");
            errorexit++;
        }
        if (VehicleDetail == "") {
            $('#VehicleDetail').addClass("border-danger");
            errorexit++;
        }
        if (CompanyLocation == "") {
            $('#CompanyLocation').addClass("border-danger");
            errorexit++;
        }

        $('#tblOne > tbody > tr').each(function () {
            var MaterialName = $(this).find('#MaterialName' + count).val();
            var MaterialGUID = $(this).find('#MaterialGUID' + count).val();
            var Quantity = $(this).find('#Quantity' + count).val();
            var PackingDetail = $(this).find('#PackingDetail' + count).val();
            var Rate = $(this).find('#Rate' + count).val();
            var Amount = $(this).find('#Amount' + count).val();

            if (MaterialName == "") {
                $('#MaterialName' + count).addClass("border-danger");
                errorexit++;
            }
            if (MaterialGUID == "") {
                $('#MaterialName' + count).addClass("border-danger");
                errorexit++;
            }
           if (Quantity == "") {
                $('#Quantity' + count).addClass("border-danger");
                errorexit++;
            }
            if (PackingDetail == "") {
                $('#PackingDetail' + count).addClass("border-danger");
                errorexit++;
            }
            if (Rate == "") {
                $('#Rate' + count).addClass("border-danger");
                errorexit++;
            }
            if (Amount == "") {
                $('#Amount' + count).addClass("border-danger");
                errorexit++;
            }
            count++;
        });
        return errorexit;
    }

    function AddNewRow(count) {
        var errorexit = checkValidationCurrentRow(count);
        if (errorexit == 0) {
            var idstringR = "#Remove" + count;
            $(idstringR).attr("hidden", true);
            var idstringA = "#Add" + count;
            $(idstringA).attr("hidden", true);
            count++;

            $('#totalCount').val(count);
            var MaterialNameID = "MaterialName" + count;
            var MaterialGUID = "MaterialGUID" + count;

            var TotalWeight = "TotalWeight" + count;
            var TotalWeightUOMType = "TotalWeightUOMType" + count;

            var Quantity = "Quantity" + count;
            var QuantityUOMType = "QuantityUOMType" + count;

            var WeightPerQuantity = "WeightPerQuantity" + count;
            var WeightPerQuantityUOMType = "WeightPerQuantityUOMType" + count;

            var Rate = "Rate" + count;
            var Amount = "Amount" + count;

            var PackingDetail = "PackingDetail" + count;
            var Remark = "Remark" + count;

            var tr = "tr" + count;
            var Remove = "Remove" + count;
            var Add = "Add" + count;



            var td1 = '<td><span>' + count + '</span></td>';
            var td2 = '<td class="pl-1 pr-1"><input style="min-width:80px" onfocus="onFocus(\'' + MaterialNameID + '\')"  type="text" class="form-control" id="' + MaterialNameID + '" name="' + MaterialNameID + '" autocomplete="off"  onkeydown="SetAutoComplete(\'' + MaterialNameID + '\',\'' + count + '\')"  ondblclick="doubleClick(\'' + MaterialNameID + '\',\'' + count + '\')" />';
            td2 += '<input type="hidden" class="form-control" id="' + MaterialGUID + '" name="' + MaterialGUID + '" autocomplete="off" /></td>';
            var td3 = '<td class="pl-1 pr-0"><input style="min-width:80px" type="number" class="form-control" id="' + Quantity + '" name="' + Quantity + '"  onfocus="onFocus(\'' + Quantity + '\')"  autocomplete="off" min="1" oninput="validity.valid||(value=\'\');" onkeyup="CalculateAmount(\'' + count + '\')"  /></td>';
            td3 += '<td class="pl-0 pr-1"><select style="min-width:100px" id="' + QuantityUOMType + '" name="' + QuantityUOMType + '"  class="form-control bg-light"></select></td>'
            var td4 = '<td class="pl-1 pr-0"><input style="min-width:80px" type="number" class="form-control" id="' + WeightPerQuantity + '" name="' + WeightPerQuantity + '" autocomplete="off" min="1" oninput="validity.valid||(value=\'\');" /></td>';
            td4 += '<td class="pl-0 pr-1"> <select style="min-width:100px" id="' + WeightPerQuantityUOMType + '" name="' + WeightPerQuantityUOMType + '"  class="form-control bg-light"></select></td>'
            var td5 = '<td class="pl-1 pr-0"><input style="min-width:80px" type="number" class="form-control" id="' + TotalWeight + '" name="' + TotalWeight + '" autocomplete="off" min="1" oninput="validity.valid||(value=\'\');" /></td>';
            td5 += '<td class="pl-0 pr-1"><select style="min-width:100px" id="' + TotalWeightUOMType + '" name="' + TotalWeightUOMType + '"  class="form-control bg-light"></select></td>'
            var td6 = '<td class="pl-1 pr-1"><input onfocus="onFocus(\'' + Rate + '\')" type="number" class="form-control" id="' + Rate + '" name="' + Rate + '" autocomplete="off" min="1" oninput="validity.valid||(value=\'\');" onkeyup="CalculateAmount(\'' + count + '\')" /></td>';
            td6 += '<td class="pl-1 pr-1"><input onfocus="onFocus(\'' + Amount + '\')" type="number" class="form-control" id="' + Amount + '" name="' + Amount + '" autocomplete="off" min="1" oninput="validity.valid||(value=\'\');" /></td>';
            var td7 = '<td class="pl-1 pr-1"><input onfocus="onFocus(\'' + PackingDetail + '\')" type="text" class="form-control" id="' + PackingDetail + '" name="' + PackingDetail + '" autocomplete="off" /></td>';
            td7 += '<td class="pl-1 pr-1"><input onfocus="onFocus(\'' + Remark + '\')" type="text" class="form-control" id="' + Remark + '" name="' + Remark + '" autocomplete="off" /></td>';
            var td8 = '<td class="pl-1 pr-1"><div class="list-icons"><button type="button" id="' + Add + '" class="m-1 btn btn-sm btn-icon rounded-round  btn-success" onclick="AddNewRow(' + count + ')" ><b><i class="icon-plus22"></i></b></button>'; //repeat
            var td9 = '<button type="button" id="' + Remove + '" class="m-1 btn btn-sm btn-icon rounded-round  btn-danger" onclick="RemoveRow(' + count + ')" ><b><i class="icon-cross2"></i></b></button></div></td>';
            $("tbody").append('<tr id="' + tr + '">' + td1 + td2 + td3 + td4 + td5 + td6 + td7 + td8 + td9 +'</tr>');
        }
    }
    function getAllData() {

        var WarehouseGUID = $('#Warehouse').val();
        //var PurchaseOrderNo = $('#PurchaseOrderNo').val();
        var SupplierGUID = $('#SupplierGUID').val();
        var CompanyLocation = $('#CompanyLocation').val();
        var PurchaseOrderDate = $('#PurchaseOrderDate').val();
        var VehicleDetail = $('#VehicleDetail').val();
        var CompanyLocation = $('#CompanyLocation').val();
        var FarmerCode = $('#FarmerCode').val();

        var data = [];
        var count = 1;
        $('#tblOne > tbody > tr').each(function () {
            var MaterialName = $(this).find('#MaterialName' + count).val();
            var MaterialGUID = $(this).find('#MaterialGUID' + count).val();
            var TotalWeight = $(this).find('#TotalWeight' + count).val();
            var TotalWeightUOMType = $(this).find('#TotalWeightUOMType' + count).val();
            var Quantity = $(this).find('#Quantity' + count).val();
            var QuantityUOMType = $(this).find('#QuantityUOMType' + count).val();
            var WeightPerQuantity = $(this).find('#WeightPerQuantity' + count).val();
            var WeightPerQuantityUOMType = $(this).find('#WeightPerQuantityUOMType' + count).val();
            var Rate = $(this).find('#Rate' + count).val();
            var Amount = $(this).find('#Amount' + count).val();
            var PackingDetail = $(this).find('#PackingDetail' + count).val();
            var Remark = $(this).find('#Remark' + count).val();

            var alldata = {
                'WarehouseGUID': WarehouseGUID,
                //'PurchaseOrderNo': PurchaseOrderNo,
                'SupplierGUID': SupplierGUID,
                'CompanyLocation': CompanyLocation,
                'PurchaseOrderDate': PurchaseOrderDate,
                'VehicleDetail': VehicleDetail,
                'FarmerCode': FarmerCode,

                'MaterialGUID': MaterialGUID,
                'MaterialName': MaterialName,
                'TotalWeight': TotalWeight,
                'TotalWeightUOMType': TotalWeightUOMType,
                'Quantity': Quantity,
                'QuantityUOMType': QuantityUOMType,
                'WeightPerQuantity': WeightPerQuantity,
                'WeightPerQuantityUOMType': WeightPerQuantityUOMType,
                'Rate': Rate,
                'Amount': Amount,
                'PackingDetail': PackingDetail,
                'Remark': Remark,
            }
            data.push(alldata);
            count++;
        });
        console.log(data);
        return data;
    }

    function RemoveRow(count) {
        var idstring = "#tr" + count;
        $(idstring).remove();

        count--;
        $('#totalCount').val(count);
        var idstringR = "#Remove" + count;
        $(idstringR).attr("hidden", false);

        var idstringA = "#Add" + count;
        $(idstringA).attr("hidden", false);
    }

    $('#btnSubmit').click(function () {
        $('#confirmModal').modal('hide');
        $.blockUI({
            message: '<i class="icon-spinner4 spinner"></i>',
            timeout: 2000, //unblock after 2 seconds
            overlayCSS: {
                backgroundColor: '#1b2024',
                opacity: 0.8,
                cursor: 'wait'
            },
            css: {
                border: 0,
                color: '#fff',
                padding: 0,
                backgroundColor: 'transparent'
            }
        });
        var data = JSON.stringify(getAllData());
        $.ajax({
            url: '@Url.Action("SavePurchaseOrder", "PurchaseOrder")',
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({ 'getepassdata': data }),
            success: function (PurchaseOrderNo) {
                if (PurchaseOrderNo != "fail") {
                    setTimeout(function () {
                        swal({
                            title: "Successfully Saved!",
                            text: "Your Purchase Order No is : " + PurchaseOrderNo,
                            type: "success"
                        }).then(function () {
                            window.location = '@Url.Action("PurchaseOrderList", "PurchaseOrder")';
                        });
                    }, 500);
                }
                else
                {

                }


                //alert("Data Added Successfully");
            },
            error: function () {
                alert("Error while inserting data");
            }
        });
    });




</script>



